<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-6H5WPV9WFH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-6H5WPV9WFH');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Logbook of Learning Domain-Driven Design: Day 5 - Blog - Hugues Gobet</title>

<meta name="description" content="In this article, I will discuss the concept of Country within the framework of a Supporting Domain, using a Domain Country as an example. I will also detail ...">
<link rel="canonical" href="https://huguesgobet.com/ddd-logbook/2025-02-17"><link rel="alternate" type="application/rss+xml" title="Blog - Hugues Gobet" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="1280.000000pt" height="1026.000000pt" viewBox="0 0 1280.000000 1026.000000"
 preserveAspectRatio="xMidYMid meet">
<metadata>
Created by potrace 1.15, written by Peter Selinger 2001-2017
</metadata>
<g transform="translate(0.000000,1026.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M5230 10251 c-54 -17 -109 -53 -190 -126 -99 -88 -148 -115 -213
-115 -67 0 -118 24 -161 76 -45 53 -129 104 -174 104 -46 0 -113 -37 -217
-119 -50 -40 -119 -86 -155 -104 -58 -29 -74 -32 -150 -32 -66 0 -96 5 -134
23 -71 32 -174 31 -244 -4 -70 -35 -104 -90 -154 -250 l-41 -132 -38 -12 c-27
-9 -74 -11 -156 -7 -70 3 -135 2 -160 -5 -97 -24 -173 -134 -174 -255 0 -96
-13 -161 -35 -183 -13 -13 -56 -25 -139 -40 -173 -30 -203 -42 -280 -112 -111
-102 -124 -145 -101 -335 9 -71 13 -144 10 -161 -16 -77 -418 -346 -518 -345
-17 0 -64 12 -105 27 -179 67 -330 15 -440 -149 -44 -66 -111 -214 -111 -247
0 -7 -36 -28 -79 -46 -43 -18 -97 -48 -118 -67 -36 -30 -41 -40 -46 -90 -6
-64 -46 -158 -85 -199 -34 -36 -97 -65 -141 -66 l-34 0 7 93 c15 218 19 513 7
567 -27 128 -71 175 -161 174 -81 -1 -160 -42 -209 -107 -143 -196 -243 -451
-277 -712 -34 -251 4 -546 101 -805 21 -56 25 -85 28 -205 4 -198 22 -235 164
-341 75 -56 129 -119 140 -163 18 -78 93 -173 158 -202 22 -10 75 -22 118 -28
98 -14 130 -30 162 -84 20 -35 25 -57 25 -108 0 -117 29 -399 55 -523 57 -285
169 -527 365 -792 l68 -91 11 -136 c25 -294 110 -503 262 -641 131 -118 276
-168 489 -170 137 0 216 10 350 46 41 11 76 16 77 12 30 -88 150 -153 284
-154 l46 0 5 -98 c4 -66 14 -121 32 -174 24 -72 25 -79 11 -130 -31 -120 -109
-317 -186 -470 -17 -35 -93 -146 -169 -248 -170 -228 -234 -329 -370 -585
-172 -326 -193 -382 -194 -515 0 -58 4 -104 12 -117 16 -28 100 -59 215 -79
74 -13 136 -15 312 -11 271 7 478 37 663 98 73 24 69 16 75 184 3 66 10 132
16 147 5 15 57 90 114 165 249 331 395 568 486 794 l23 55 82 0 c58 0 99 7
146 23 48 17 78 22 113 17 62 -7 152 -56 223 -120 68 -62 79 -30 -96 -291
-162 -243 -216 -340 -340 -608 -131 -285 -152 -346 -158 -468 -6 -131 5 -161
66 -187 74 -32 153 -42 323 -42 162 0 304 15 489 51 113 23 315 81 360 104
l28 15 4 153 3 153 114 174 c210 320 307 493 392 695 l38 90 103 6 c189 10
241 56 322 282 22 59 65 103 117 119 35 10 53 8 132 -12 58 -14 133 -25 202
-27 100 -4 114 -2 155 19 56 29 84 76 105 178 24 112 43 156 80 189 48 42 100
47 200 21 208 -54 508 -75 965 -67 179 3 365 11 413 17 49 6 91 10 93 7 9 -9
-37 -193 -81 -325 -24 -73 -73 -194 -108 -270 -55 -119 -83 -164 -202 -323
-181 -240 -223 -307 -377 -594 -155 -292 -188 -376 -195 -500 -6 -110 3 -138
56 -165 195 -99 743 -81 1127 37 95 29 94 26 94 177 1 145 5 156 148 348 361
486 494 753 617 1237 23 93 25 116 25 345 0 135 4 247 8 250 15 9 120 -41 185
-87 171 -122 288 -340 343 -639 21 -112 29 -408 15 -533 -10 -93 -92 -401
-137 -517 -23 -56 -75 -142 -152 -248 -110 -152 -171 -292 -186 -430 -5 -42
-3 -46 29 -68 53 -34 174 -71 292 -88 132 -20 463 -22 643 -5 272 27 365 65
413 170 24 55 26 174 7 398 -16 181 -11 236 55 628 63 371 77 491 78 655 0
225 -11 275 -108 470 -173 346 -209 457 -208 645 0 216 38 368 184 738 259
657 333 954 355 1432 6 124 9 145 23 143 20 -4 43 -69 91 -253 92 -359 120
-668 120 -1339 l0 -418 -85 -133 c-250 -392 -320 -660 -236 -900 13 -37 32
-65 62 -92 101 -88 99 -86 99 -155 0 -49 -10 -94 -45 -196 -75 -220 -80 -329
-21 -457 20 -44 36 -60 97 -102 126 -84 160 -155 179 -373 19 -221 45 -287
152 -396 55 -56 74 -84 92 -135 13 -35 29 -65 35 -67 6 -2 43 28 81 67 89 90
151 215 216 436 75 256 98 375 120 637 5 59 13 80 81 200 157 275 189 367 180
506 -7 98 -34 198 -88 327 -38 93 -39 97 -39 222 -1 319 -31 371 -325 568
-164 111 -164 110 -210 281 -58 212 -66 309 -75 944 -9 612 -10 628 -65 985
-69 440 -188 714 -410 944 -138 143 -311 273 -530 399 -237 136 -561 475 -811
847 -216 321 -474 774 -474 833 0 17 16 86 36 154 20 68 44 153 52 190 15 66
15 66 -11 111 -36 62 -73 77 -186 77 -170 0 -246 35 -308 140 -69 118 -80 133
-126 167 -66 48 -131 71 -254 88 -119 17 -157 31 -196 70 -41 41 -63 82 -86
160 -26 84 -49 119 -107 163 -52 40 -118 62 -188 62 -28 0 -125 -18 -216 -40
-172 -42 -220 -47 -266 -30 -14 6 -68 50 -119 98 -125 118 -182 146 -295 146
-72 0 -101 -6 -193 -38 -103 -35 -111 -37 -163 -26 -30 7 -110 39 -177 73
-117 60 -125 62 -197 62 -92 0 -151 -27 -255 -116 -69 -60 -70 -60 -121 -55
-78 9 -108 23 -202 97 -132 105 -202 119 -367 73 -185 -53 -236 -45 -377 58
-79 58 -156 99 -181 97 -7 0 -23 -4 -37 -8z"/>
</g>
</svg>
<a title="Your Site Description
" href="/">Blog - Hugues Gobet</a></div></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/ddd-journey">DDD Journey</a></li><li class="navigation__item"><a href="/other">Other articles</a></li><li class="navigation__item"><a href="/about">About</a></li></ul>
        <form id="language-switcher" action="" method="get">
          <select name="lang" onchange="location = this.value;">
            <option value="/fr/ddd-logbook/2025-02-17" >Français</option>
            <option value="/ddd-logbook/2025-02-17" selected>English</option>
          </select>
        </form>
        
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root">
    <div class="sidebar-profile">
        <img src="/assets/images/me.png" alt="Hugues Gobet" class="sidebar-avatar">
        <h2 class="sidebar-name">Hugues Gobet</h2>

        <p class="sidebar-bio">
            
                Web developer, lead developer, and software architecture enthusiast.
            
    </div>
    <div class="sidebar-social">
        <ul class="social-icons">
            
            <li>
                <a href="https://medium.com/@hugues.gobet" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-medium"></i>
                </a>
            </li>
            
            
            <li>
                <a href="https://www.linkedin.com/in/hugues-gobet-854756bb/" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-linkedin"></i>
                </a>
            </li>
            
            
            <li>
                <a href="https://github.com/tegbessou" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-github"></i>
                </a>
            </li>
            
        </ul>
    </div>
</div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>Logbook of Learning Domain-Driven Design: Day 5</h1></header></div><meta itemprop="headline" content="Logbook of Learning Domain-Driven Design: Day 5"><div class="article__info clearfix"><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Feb 17, 2025</span>
            </li></ul></div><meta itemprop="author" content="Hugues Gobet"/><meta itemprop="datePublished" content="2025-02-17T08:00:00+00:00"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p>In this article, I will discuss the concept of <strong>Country</strong> within the framework of a <strong>Supporting Domain</strong>, using a <strong>Domain Country</strong> as an example. I will also detail the exposure of an API that allows retrieving information about a <strong>Country</strong> and verifying its existence. I will begin by revisiting the definition of a <strong>Supporting Subdomain</strong>, then explain how to implement it step by step.</p>

<h2 id="supporting-subdomain-what-is-it">Supporting Subdomain: What Is It?</h2>

<p>As the name suggests, a <strong>Supporting Subdomain</strong> is, first and foremost, a <strong>Subdomain</strong>: it represents a part of the <strong>Domain</strong> that can be separated into a <strong>module</strong>. In a business project, a dedicated team could be responsible for it. A <strong>Subdomain</strong> can also have its own <strong>Ubiquitous Language</strong> when it belongs to a <strong>Bounded Context</strong> different from the <strong>Core Domain</strong>.</p>

<p>Although important to the business, the <strong>Supporting Subdomain</strong> is less critical than the <strong>Core Domain</strong>. Creating a <strong>Supporting Domain</strong> is only relevant if it provides specific value or addresses a particular need.</p>

<p>In the case of our wine bottle management API, I created a <strong>Domain Country</strong> to separate this concept from the <strong>Core Domain</strong>, which manages the <strong>Bottle Inventory</strong>. This separation helps organize the code into two distinct <strong>Bounded Contexts</strong>. Additionally, this <strong>Domain</strong> is essential for providing a list of countries when creating a bottle while ensuring that the country actually exists. However, since it remains less crucial than the <strong>Core Domain</strong>, it fits perfectly within the definition of a <strong>Supporting Subdomain</strong>.</p>

<h2 id="how-to-implement-the-domain">How to Implement the Domain?</h2>

<p>In this article, I will illustrate the implementation of the <strong>Domain</strong> through two use cases. I have chosen not to separate these cases into multiple sections because they are quite repetitive and do not pose a significant challenge in terms of <strong>Domain-Driven Design (DDD)</strong>. Here are the two scenarios I will cover:</p>
<ul>
  <li>Creating a <strong>Country</strong></li>
  <li>Retrieving the list of all <strong>Countries</strong></li>
</ul>

<p>I propose tackling this topic using a different approach than the one taken for the authentication use case. Therefore, I will start by defining the <strong>Entity</strong>, along with unit tests, to integrate a <strong>Test-Driven Development (TDD)</strong> approach.</p>

<h2 id="quick-introduction-to-tdd">Quick Introduction to TDD</h2>

<p><strong>Test-Driven Development (TDD)</strong> is a very interesting development methodology that would deserve a dedicated article (maybe an idea for a future special edition). If you’re looking for more in-depth information, I highly recommend the book <em>Test-Driven Development: By Example</em> by Kent Beck.</p>

<p>The fundamental idea behind this methodology is to write tests before writing the corresponding functionality. However, the essence of this approach lies in a step-by-step, progressive, and rigorous process.</p>

<p>To illustrate this method, I will walk you through the tests related to the creation of a <strong>Country Entity</strong>.</p>

<h3 id="step-1-testing-the-creation-of-a-country-entity">Step 1: Testing the Creation of a Country Entity</h3>

<p>We will begin with a simple test to validate the correct creation of a <strong>Country Entity</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">testCreateSuccess</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$country</span> <span class="o">=</span> <span class="nc">Country</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span>
        <span class="nc">CountryId</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'af785dbb-4ac1-4786-a5aa-1fed08f6ec26'</span><span class="p">),</span>
        <span class="nc">CountryName</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'France'</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertInstanceOf</span><span class="p">(</span>
        <span class="nc">Country</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
        <span class="nv">$country</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
        <span class="s1">'af785dbb-4ac1-4786-a5aa-1fed08f6ec26'</span><span class="p">,</span>
        <span class="nv">$country</span><span class="o">-&gt;</span><span class="nf">id</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
    <span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span>
        <span class="s1">'France'</span><span class="p">,</span>
        <span class="nv">$country</span><span class="o">-&gt;</span><span class="nf">name</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This test precisely defines the expected output of the <strong>Factory</strong> <strong><em>create</em></strong> method. In a <strong>TDD</strong> approach, the goal is to obtain a green test (i.e., a successful test) as quickly as possible.</p>

<p>Upon the first execution of the test, an error occurs immediately: the class does not exist.</p>

<p><img src="/assets/images/2025-02-17/first-step-test.png" alt="First error Unit Test" /></p>

<p>This situation is completely normal and is an integral part of the <strong>TDD</strong> process. Each correction step aims to fix the current error in order to gradually build an implementation validated by tests.</p>

<p>To quickly obtain a green test, I started by creating the Country Entity, which changed the error message.</p>

<p><img src="/assets/images/2025-02-17/first-bis-step-test.png" alt="First bis error Unit Test" /></p>

<p>I then created a <strong><em>create</em></strong> method in the <strong>Country Entity</strong>. At first, this method does nothing, but it helps progress toward a successful test.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">Country</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">():</span> <span class="kt">self</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The new error message indicates that the <strong>Value Object CountryId</strong> does not exist.</p>

<p><img src="/assets/images/2025-02-17/second-step-test.png" alt="Second error Unit Test" /></p>

<p>To resolve this issue, I created the <strong>CountryId Value Object</strong>, keeping it as simple as possible.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryId</span>
<span class="p">{</span>
    
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The next message states that it cannot find the <strong><em>fromString</em></strong> method. So, I added it.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryId</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$value</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>At this point, we get another message indicating that the <strong>Value Object CountryName</strong> does not exist.</p>

<p><img src="/assets/images/2025-02-17/third-step-test.png" alt="Third error Unit Test" /></p>

<p>I then created the class, and just like with <strong>CountryId</strong>, I anticipated the need by adding a <strong><em>fromString</em></strong> method.</p>

<h3 id="future-considerations">Future Considerations</h3>

<p>The idea is to only anticipate small portions of code, step by step, to stay focused on the main goal: making the test pass (turn green) as quickly as possible.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryName</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$value</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The test error message has now evolved and indicates that the <strong>Factory</strong> method of the <strong>Country Entity</strong> does not return an <strong>Entity</strong>. To fix this issue, we adopt the simplest possible approach.</p>

<p><img src="/assets/images/2025-02-17/fifth-step-test.png" alt="Fifth error Unit Test" /></p>

<p>To correct this, I ensure that the <strong><em>create</em></strong> method returns a <strong>Country Entity</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">Country</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">():</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now, the method does return an <strong>Entity</strong>, but the tests report a new error: the absence of a method to expose the <strong>identifier</strong>. The same issue will also arise for the <strong>name</strong> attribute.</p>

<p><img src="/assets/images/2025-02-17/sixth-step-test.png" alt="Sixth error Unit Test" /></p>

<p>I now need to create these methods. Before implementing them, it is crucial to determine what they should return. To keep it simple, they will return exactly what the test expects them to return.</p>

<p>At this point:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryId</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryName</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">Country</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">():</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">CountryId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nc">CountryId</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'af785dbb-4ac1-4786-a5aa-1fed08f6ec26'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">():</span> <span class="kt">CountryName</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nc">CountryName</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span>
            <span class="s1">'France'</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The test should now pass. However, in the <strong>Value Objects</strong>, the <strong><em>value</em></strong> method is missing, which is needed to retrieve their value. I will now add it.</p>

<p>Another issue lies in assigning the value passed into the <strong><em>fromString</em></strong> method. I will resolve both problems in a single operation.</p>

<p>Current State of the <strong>Value Objects</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryId</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="nv">$value</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$value</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">value</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryName</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="nv">$value</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$value</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">value</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>At this stage, here’s what the <strong>Value Objects</strong> look like. The goal of making the tests pass (turn green) has been achieved, which is perfect.</p>

<p><img src="/assets/images/2025-02-17/seventh-step-test.png" alt="Seventh error Unit Test" /></p>

<p>All of this is great, but we took a shortcut by hardcoding the values inside the <strong>Entity</strong>. We achieved the test’s goal quickly, in the most naive way possible. Now, we need to move on to the second step: refactoring the code to improve it and make it fully functional.</p>

<h3 id="step-two-making-the-code-functional">Step Two: Making the Code Functional</h3>

<p>To achieve this, the <strong>Country Entity</strong> must have two distinct properties: one for the <strong>ID</strong> and one for the <strong>name</strong>. Additionally, the <strong><em>id</em></strong> and <strong><em>name</em></strong> methods should return the values of these properties. The refactoring must be done in small steps, ensuring that we only work on what is covered by the test. Since the test in this example focuses on the <strong><em>create</em></strong> method, I will limit my refactoring to code related to this method, without modifying other <strong>Entities</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryId</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryName</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">Country</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">():</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">CountryId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">():</span> <span class="kt">CountryName</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This is what the <strong>Entity</strong> looks like now. Let’s rerun the tests to see if they still pass.</p>

<p><img src="/assets/images/2025-02-17/eighth-step-test.png" alt="Eighth error Unit Test" /></p>

<p>And then… disaster strikes! The test fails. We’re back to square one: getting the test to pass again as quickly as possible.
According to the error message, the <strong>Country Entity</strong> constructor must take two parameters. However, looking at the <strong>Entity</strong>’s code, we notice that no arguments are passed to the constructor inside the <strong><em>create</em></strong> method. Therefore, this method must accept these two parameters so they can be passed to the <strong>Entity</strong>’s constructor.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryId</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Country\Domain\ValueObject\CountryName</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">Country</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span>
        <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span>
            <span class="nv">$id</span><span class="p">,</span>
            <span class="nv">$name</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">CountryId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">():</span> <span class="kt">CountryName</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After rerunning the test, it finally passes (turns green).</p>

<p><img src="/assets/images/2025-02-17/nineth-step-test.png" alt="Nineth error Unit Test" /></p>

<p>We have now created the <strong>Country Entity</strong>’s method following <strong>TDD</strong> best practices.</p>

<h3 id="key-takeaways">Key Takeaways</h3>

<p>By following <strong>TDD</strong>, we ensure that the test perfectly reflects the business requirement and that it is correctly validated. I highly recommend adopting this approach as much as possible, as it simplifies the design of business use cases and ensures that your business logic has near 100% code coverage.</p>

<h2 id="adding-value-to-value-object">Adding Value to Value Object</h2>

<p>To increase the value of <strong>Value Objects</strong>, it is essential to add validation rules for their content. For example, we can verify that the <strong>CountryId Value Object</strong> is a valid <strong><em>UUID</em></strong>. To do this, we can either use an existing library or write our own validation logic. Of course, we start by writing a test, then implement the validation inside the corresponding <strong>Entity</strong>.</p>

<p>Here is what the test looks like:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">testCreateBadIdNotUuid</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">expectException</span><span class="p">(</span><span class="nc">\InvalidArgumentException</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>

    <span class="nc">Country</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span>
        <span class="nc">CountryId</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'12'</span><span class="p">),</span>
        <span class="nc">CountryName</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="s1">'France'</span><span class="p">),</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>As expected, it fails.</p>

<p><img src="/assets/images/2025-02-17/ten-step-test.png" alt="Ten error Unit Test" /></p>

<p>To make the test pass quickly, we need to add a verification in the <strong>Value Object</strong> to ensure that the provided value is a valid <strong><em>UUID</em></strong>.
For this, I use the PHP library: https://github.com/webmozarts/assert. First, I install it following the official documentation. Then, I simply add the appropriate validation to throw the expected exception.
Here is the updated <strong>Value Object</strong> code:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\ValueObject</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Webmozart\Assert\Assert</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryId</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nv">$value</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">string</span> <span class="nv">$value</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nc">Assert</span><span class="o">::</span><span class="nf">uuid</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromString</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$value</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">value</span><span class="p">():</span> <span class="kt">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now, let’s run the test:</p>

<p><img src="/assets/images/2025-02-17/eleven-step-test.png" alt="Eleven error Unit Test" /></p>

<p>Perfect! 
This <strong>Domain</strong>, being very simple and with few rules, is now complete. In the future, we will explore more complex <strong>Domains</strong>.</p>

<h2 id="implementing-use-cases">Implementing Use Cases</h2>

<p>Now, we will proceed to develop the use cases within the Domain we just created.</p>

<h3 id="creating-a-country">Creating a Country</h3>

<p>We start by importing products from a file retrieved online.</p>

<p><img src="/assets/images/2025-02-17/import-country-usecase.png" alt="Import countries use case" /></p>

<p>The first step is to write the test for the <strong>Primary Adapter</strong>, which is the <strong><em>Symfony Command ImportCountryCommand</em></strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">testExecute</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="k">self</span><span class="o">::</span><span class="nf">bootkernel</span><span class="p">();</span>
    <span class="nv">$application</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Application</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="nv">$kernel</span><span class="p">);</span>
    <span class="nv">$command</span> <span class="o">=</span> <span class="nv">$application</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'country:import'</span><span class="p">);</span>
    <span class="nv">$commandTester</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommandTester</span><span class="p">(</span><span class="nc">Scommand</span><span class="p">);</span>
    <span class="nv">$commandTester</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">([]);</span>
    <span class="nv">$commandTester</span><span class="o">-&gt;</span><span class="nf">assertCommandIsSuccessful</span><span class="p">();</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$commandTester</span><span class="o">-&gt;</span><span class="nf">getDisplay</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertStringContainsString</span><span class="p">(</span><span class="s1">'[OK] Countries created: 241'</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The code in question is related to <strong><em>Symfony</em></strong>, so I won’t dwell on it too much. The key point here is understanding the assertion that validates the test: at the end of the command, the message “[OK] Countries created: 241” must be displayed, showing the number of countries created.</p>

<p>Once this verification is complete, we can move on to the code. The <strong><em>Symfony Command</em></strong> itself is not particularly interesting, as it mainly handles file reading, which falls under the <strong>Infrastructure</strong> layer , not the <strong>Domain</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="k">private</span> <span class="k">function</span> <span class="n">handleFile</span><span class="p">():</span> <span class="kt">int</span>
<span class="p">{</span>
    <span class="nv">$countryCreated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$handle</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">getFilePath</span><span class="p">(),</span> <span class="s1">'r'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$handle</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">\RuntimeException</span><span class="p">(</span><span class="s1">'Unable to open file'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">((</span><span class="nv">$data</span> <span class="o">=</span> <span class="nb">fgetcsv</span><span class="p">(</span><span class="nv">$handle</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">commandBus</span><span class="o">-&gt;</span><span class="nf">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nc">CreateCountryCommand</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
        <span class="o">++</span><span class="nv">$countryCreated</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$handle</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$countryCreated</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="future-considerations-1">Future Considerations</h3>

<p>Here, we could also format a table containing all the country names and dispatch a <strong>Command</strong> to import them all at once. This approach would better align with <strong>CQRS</strong>, where any change to the system should be encapsulated in a single <strong>Command</strong>. I believe this modification should be made.</p>

<p>Here is an excerpt from the <strong><em>Symfony Command</em></strong>, showing the section responsible for reading the file and dispatching the <strong>Command</strong>. I will go over this part quickly, as it is not crucial here. What matters is that the file is read, and a <strong>Command</strong> is dispatched with the country name contained in it. For this <strong>Domain</strong>, I only need the name—no other information. However, depending on the needs of the <strong>Domain Country</strong> or the <strong>Core Domain</strong>, additional details could be processed.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Application\Command</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Application\Command\CommandInterface</span><span class="p">;</span>

<span class="cd">/**
 * @implements CommandInterface&lt;void&gt;
 */</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CreateCountryCommand</span> <span class="kd">implements</span> <span class="nc">CommandInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The Command is very simple and only takes a <strong>name</strong> as input.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Application\Command</span><span class="p">;</span>

<span class="na">#[AsCommandHandler]</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CreateCountryCommandHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryRepositoryInterface</span> <span class="nv">$countryRepository</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">DomainEventDispatcherInterface</span> <span class="nv">$dispatcher</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">IdFactory</span> <span class="nv">$idFactory</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @throws CountryAlreadyExistsException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">CreateCountryCommand</span> <span class="nv">$command</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">countryRepository</span><span class="o">-&gt;</span><span class="nf">ofName</span><span class="p">(</span><span class="nc">CountryName</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">CountryAlreadyExistsException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$country</span> <span class="o">=</span> <span class="nc">Country</span><span class="o">::</span><span class="nf">create</span><span class="p">(</span>
            <span class="nc">CountryId</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">idFactory</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">()),</span>
            <span class="nc">CountryName</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">countryRepository</span><span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dispatcher</span><span class="o">-&gt;</span><span class="nf">dispatch</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <strong>CommandHandler</strong> is part of the <strong>Application</strong> layer. It serves as a bridge between the <strong>Infrastructure</strong> layer and the <strong>Domain</strong>. The <strong>CommandHandler</strong> first checks if the <strong>Country</strong> already exists using the <strong>Repository</strong>. If the <strong>Country</strong> is already present, an exception is thrown. Since each <strong>Country</strong> <strong>name</strong> is unique, we can safely search by <strong>name</strong> to ensure uniqueness. The <strong>Factory</strong> method of our <strong>Country Entity</strong> allows us to create the <strong>Country</strong>. Once created, it is stored in the system using the <strong>Repository</strong>. Finally, we dispatch the <strong>Domain Events</strong> related to the creation of the <strong>Country</strong>.</p>

<p>The <strong>Repository</strong> is a <strong>Domain</strong>-level concept, so we create an <strong><em>Interface</em></strong> to apply <strong>Dependency Inversion</strong>: We declare an <strong><em>Interface</em></strong> for a <strong>Repository</strong> (e.g., with an add method) inside the <strong>Domain</strong>. We then implement the add method in the <strong>Infrastructure</strong>  layer, which saves the new <strong>Entity</strong> in the database.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Repository</span><span class="p">;</span>

<span class="cd">/**
 * @extends RepositoryInterface&lt;Country&gt;
 */</span>
<span class="kd">interface</span> <span class="nc">CountryRepositoryInterface</span> <span class="kd">extends</span> <span class="nc">RepositoryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ofName</span><span class="p">(</span><span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">?Country</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">Country</span> <span class="nv">$country</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In the <strong>Repository</strong>, we define two essential methods to interact with the <strong>Domain</strong>:
– <strong><em>ofName</em></strong>: Retrieves a <strong>Country</strong> by its name or returns null if the <strong>Country</strong> does not exist.
– <strong><em>add</em></strong>: Saves the <strong>Country</strong> in the system.</p>

<p>The implementation of the <strong>Repository</strong> is not particularly complex since it is <strong><em>Symfony-related</em></strong>, but I am including it here to complete the implementation.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Infrastructure\Doctrine\Repository</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">CountryDoctrineRepository</span> <span class="kd">implements</span> <span class="nc">CountryRepositoryInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="no">string</span> <span class="no">ENTITY_CLASS</span> <span class="o">=</span> <span class="nc">CountryDoctrine</span><span class="o">::</span><span class="n">class</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="no">string</span> <span class="no">ALIAS</span> <span class="o">=</span> <span class="s1">'country'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">EntityManagerInterface</span> <span class="nv">$entityManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$entityManager</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="no">ENTITY_CLASS</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="no">ALIAS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ofName</span><span class="p">(</span>
        <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">?Country</span> <span class="p">{</span>
        <span class="nv">$country</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityManager</span>
            <span class="o">-&gt;</span><span class="nf">getRepository</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="no">ENTITY_CLASS</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">findOneBy</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">()])</span>
        <span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$country</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nc">CountryMapper</span><span class="o">::</span><span class="nf">toDomain</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">Country</span> <span class="nv">$country</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$countryDoctrine</span> <span class="o">=</span> <span class="nc">CountryMapper</span><span class="o">::</span><span class="nf">toInfrastructurePersist</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityManager</span><span class="o">-&gt;</span><span class="nf">persist</span><span class="p">(</span><span class="nv">$countryDoctrine</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">entityManager</span><span class="o">-&gt;</span><span class="nb">flush</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I won’t go into the details of the implementation, but we can clearly see the two methods declared in the <strong>Repository</strong> <strong><em>Interface</em></strong>.</p>

<p>This concludes the implementation of the use case for creating a <strong>Country</strong>. Now, I will add a small feature to the <strong>Domain</strong>: registering a <strong>Domain Event</strong> when a <strong>Country Entity</strong> is created.</p>

<h2 id="registering-a-domain-event-for-the-creation-of-a-country-entity">Registering a Domain Event for the Creation of a Country Entity</h2>
<p>To achieve this, I created an <strong><em>Interface</em></strong> that <strong>Entities</strong> must implement to record their business events. Then, I use an <strong><em>Event Dispatcher</em></strong> to dispatch all the events of an <strong>Entity</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Shared\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Shared\Domain\Event\DomainEventInterface</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">EntityWithDomainEventInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @return DomainEventInterface[]
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getRecordedEvent</span><span class="p">():</span> <span class="kt">array</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">recordEvent</span><span class="p">(</span><span class="kt">DomainEventInterface</span> <span class="nv">$event</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">eraseRecordedEvents</span><span class="p">():</span> <span class="kt">void</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This <strong><em>Interface</em></strong> defines three methods:</p>
<ol>
  <li><strong><em>getRecordedEvent</em></strong>: Retrieves all <strong>Domain Events</strong> recorded for an <strong>Entity</strong>.</li>
  <li><strong><em>recordEvent</em></strong>: Records a <strong>Domain Event</strong> after an action in the <strong>Domain</strong>.</li>
  <li><strong><em>eraseRecordedEvents</em></strong>: Deletes recorded <strong>Domain Events</strong> after they are dispatched, ensuring they are not processed twice.</li>
</ol>

<p>To create the methods linked to this <strong><em>Interface</em></strong>, <strong>Domain Events</strong> themselves must also implement an <strong><em>Interface</em></strong>. This <strong><em>Interface</em></strong> will be used to type the <strong>Domain Events</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Shared\Domain\Event</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">DomainEventInterface</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, we must ensure that the <strong>Country Entity</strong> implements these methods. To do so, I chose to create a <strong><em>PHP Trait</em></strong>, allowing us to add these methods to the <strong>Entity</strong> without using inheritance.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Shared\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Shared\Domain\Event\DomainEventInterface</span><span class="p">;</span>

<span class="kd">trait</span> <span class="nc">EntityDomainEventTrait</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">array</span> <span class="nv">$recordedEvents</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">getRecordedEvent</span><span class="p">():</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">::</span><span class="nv">$recordedEvents</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">recordEvent</span><span class="p">(</span><span class="kt">DomainEventInterface</span> <span class="nv">$event</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="k">self</span><span class="o">::</span><span class="nv">$recordedEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$event</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">eraseRecordedEvents</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="k">self</span><span class="o">::</span><span class="nv">$recordedEvents</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>For the <strong>Country Entity</strong> to use these methods, it must: Implement the <strong><em>interface</em></strong> <strong><em>EntityWithDomainEventInterface</em></strong>, and Use the Trait. <strong><em>EntityDomainEventTrait</em></strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">Country</span> <span class="kd">implements</span> <span class="nc">EntityWithDomainEventInterface</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">EntityDomainEventTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span>
        <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span>
            <span class="nv">$id</span><span class="p">,</span>
            <span class="nv">$name</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">CountryId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">():</span> <span class="kt">CountryName</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>At this point, the <strong>Country Entity</strong> is ready to record <strong>Domain Events</strong>. The <strong>Domain Event</strong> will indicate that a <strong>Country</strong> has been created, containing the <strong>ID</strong> and <strong>name</strong>. To implement this, we create a <strong>Domain Event</strong>: <strong>CountryCreated</strong>. A <strong>Domain Event</strong> must be identifiable to ensure the same <strong>Domain Event</strong> is not processed multiple times. It must also have a publication date, so it can be processed in the correct order if event sequencing is important.</p>

<p>To meet these requirements, I created an <strong><em>Abstract Class</em></strong>, which adds these details to every <strong>Domain Event</strong> we create through inheritance.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Shared\Domain\Event</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Ramsey\Uuid\Uuid</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Contracts\EventDispatcher\Event</span><span class="p">;</span>

<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">DomainEvent</span> <span class="kd">extends</span> <span class="nc">Event</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="nv">$occurredOn</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="nc">Uuid</span><span class="o">::</span><span class="nf">uuid4</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">toString</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">occurredOn</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, we create the <strong><em>Event</em></strong> that extends this class and implements the previously created <strong><em>Interface</em></strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Event</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Shared\Domain\Event\DomainEvent</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Shared\Domain\Event\DomainEventInterface</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">CountryCreated</span> <span class="kd">extends</span> <span class="nc">DomainEvent</span> <span class="kd">implements</span> <span class="nc">DomainEventInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$countryId</span><span class="p">,</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The final step is to register this <strong>Domain Event</strong> when the <strong>Country</strong> is created.</p>

<p>Registering a <strong>Domain Event</strong> for every system action is not mandatory. However, it is very useful to maintain a clear separation of concerns. The <strong>CommandHandler</strong> is responsible for creating the <strong>Country Entity</strong>. If additional actions need to be performed, they should not be part of the <strong>CommandHandler</strong> itself. Segmenting code and <strong>Domain Events</strong> is a great way to achieve this separation. For instance, this <strong>Domain Event</strong> could be listened to in order to: Write the <strong>Country</strong> into the read model, and Notify another <strong>Domain</strong> that a new <strong>Country</strong> has been created.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Entity</span><span class="p">;</span>

<span class="k">final</span> <span class="kd">class</span> <span class="nc">Country</span> <span class="kd">implements</span> <span class="nc">EntityWithDomainEventInterface</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">EntityDomainEventTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span>
        <span class="kt">CountryId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">CountryName</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">self</span> <span class="p">{</span>
        <span class="nv">$country</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span>
            <span class="nv">$id</span><span class="p">,</span>
            <span class="nv">$name</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="nv">$country</span><span class="o">::</span><span class="nf">recordEvent</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">CountryCreated</span><span class="p">(</span>
                <span class="nv">$country</span><span class="o">-&gt;</span><span class="n">id</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
                <span class="nv">$country</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$country</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">CountryId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">name</span><span class="p">():</span> <span class="kt">CountryName</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <strong>Domain Event</strong> is registered and will be dispatched in the <strong>CommandHandler</strong> using this line:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dispatcher</span><span class="o">-&gt;</span><span class="nf">dispatch</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="future-considerations-2">Future Considerations</h3>
<p>It’s very important to dispatch the <strong>Domain Event</strong> after the action has been performed.</p>

<p>The creation process for the <strong>Country Entity</strong> is now complete.</p>

<h2 id="exposing-a-list-of-countries">Exposing a List of Countries</h2>

<p>Now, we want to expose a list of countries via an API. To achieve this, we will use <strong><em>API Platform</em></strong> (https://api-platform.com/), a framework that simplifies the creation of REST APIs while adhering to industry standards.</p>

<h3 id="quick-overview-of-api-platform">Quick Overview of API Platform</h3>

<p>This comprehensive framework is based on <strong><em>Resource</em></strong> classes, where we declare operations. These operations are linked to HTTP verbs (GET, PUT, POST, DELETE), and each operation is assigned: A <strong><em>Processor</em></strong> (for PUT, DELETE, and POST). A <strong><em>Provider</em></strong> (for GET).
API Platform offers a vast array of features, but I will only scratch the surface to ensure you understand the key elements when reading the code.</p>

<p>Here is my use case:</p>

<p><img src="/assets/images/2025-02-17/reas-list-product.png" alt="Read list product" /></p>

<p>As explained earlier, when using <strong><em>API Platform</em></strong>, the <strong>Primary Adapter</strong> is the <strong>Country</strong> <strong><em>Provider</em></strong>.</p>

<p>I start by writing a quick test to retrieve my list of <strong>countries</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="k">public</span> <span class="k">function</span> <span class="n">testGetCollection</span><span class="p">():</span> <span class="kt">void</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/api/countries'</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertResponseIsSuccessful</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertJsonContains</span><span class="p">([</span>
        <span class="s1">'@context'</span> <span class="o">=&gt;</span> <span class="s1">'/api/contexts/Country'</span><span class="p">,</span>
        <span class="s1">'@id'</span> <span class="o">=&gt;</span> <span class="s1">'/api/countries'</span><span class="p">,</span>
        <span class="s1">'@type'</span> <span class="o">=&gt;</span> <span class="s1">'Collection'</span><span class="p">,</span>
        <span class="s1">'member'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s1">'@type'</span> <span class="o">=&gt;</span> <span class="s1">'Country'</span><span class="p">,</span>
                <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Afghanistan'</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s1">'@type'</span> <span class="o">=&gt;</span> <span class="s1">'Country'</span><span class="p">,</span>
                <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Afrique du Sud'</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>
        <span class="s1">'totalItems'</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>In this test, I send a request to the URI /api/countries, which returns a list of <strong>Country</strong> objects with their names. I expect to retrieve thirty <strong>countries</strong>, as pagination is enabled by default in <strong><em>API Platform</em></strong>, grouping results into batches of thirty.</p>

<p>The next step is to create the <strong><em>Resource Country</em></strong>, which is different from the <strong>Country Entity</strong>. The responsibility of this <strong><em>Resource</em></strong> is to: Manage the <strong><em>API Platform</em></strong> operation and return the requested data via the API.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Infrastructure\ApiPlatform\Resource</span><span class="p">;</span>

<span class="err">#</span><span class="p">[</span><span class="nf">ApiResource</span><span class="p">(</span>
    <span class="n">shortName</span><span class="o">:</span> <span class="s1">'Country'</span><span class="p">,</span>
<span class="p">)]</span>
<span class="err">#</span><span class="p">[</span><span class="nf">GetCollection</span><span class="p">(</span>
    <span class="s1">'/countries'</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">:</span> <span class="p">[</span><span class="nc">CountryFilter</span><span class="o">::</span><span class="n">class</span><span class="p">],</span>
    <span class="n">provider</span><span class="o">:</span> <span class="nc">GetCountryCollectionProvider</span><span class="o">::</span><span class="n">class</span><span class="p">,</span>
<span class="p">)]</span>
<span class="k">final</span> <span class="kd">class</span> <span class="nc">GetCollectionCountryResource</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="na">#[ApiProperty(readable: false, writable: false, identifier: true)]</span>
        <span class="k">public</span> <span class="kt">?AbstractUid</span> <span class="nv">$id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="na">#[ApiProperty]</span>
        <span class="k">public</span> <span class="kt">?string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">fromModel</span><span class="p">(</span><span class="kt">Country</span> <span class="nv">$country</span><span class="p">):</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">Uuid</span><span class="p">(</span><span class="nv">$country</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">),</span>
            <span class="nv">$country</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>To achieve this, we: Add a <strong><em>GetCollection</em></strong> operation, since we want to retrieve a list of <strong><em>Country Resources</em></strong>. Specify a <strong><em>Provider</em></strong>, which will be responsible for dispatching the <strong>Query</strong> to fetch the data. Define the fields to be returned. Add the <strong><em>ApiProperty</em></strong> attribute to indicate that these properties must be exposed via the API. Create a <strong><em>fromModel</em></strong> method to transform <strong>Country Entities</strong> into <strong><em>Country Resources</em></strong>.</p>

<p>Additionally, I have specified a filters argument in the <strong><em>GetCollection</em></strong> attribute. This allows us to define one or multiple filters, which are useful: Internally for <strong><em>API Platform</em></strong>. To appear in the API response metadata. I won’t go into further detail here, as it’s not essential for understanding <strong>DDD</strong>, but here is what the <strong><em>CountryFilter</em></strong> class looks like:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Infrastructure\ApiPlatform\OpenApi</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">ApiPlatform\Metadata\FilterInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Symfony\Component\PropertyInfo\Type</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">CountryFilter</span> <span class="kd">implements</span> <span class="nc">FilterInterface</span>
<span class="p">{</span>
    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">getDescription</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$resourceClass</span><span class="p">):</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'property'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span><span class="p">,</span>
                <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nc">Type</span><span class="o">::</span><span class="no">BUILTIN_TYPE_STRING</span><span class="p">,</span>
                <span class="s1">'required'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The <strong><em>Country Provider</em></strong>:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Infrastructure\ApiPlatform\State\Provider</span><span class="p">;</span>

<span class="cd">/**
 * @implements ProviderInterface&lt;GetCollectionCountryResource&gt;
 */</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">GetCountryCollectionProvider</span> <span class="kd">implements</span> <span class="nc">ProviderInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">QueryBusInterface</span> <span class="nv">$queryBus</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">Pagination</span> <span class="nv">$pagination</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @return Paginator&lt;GetCollectionCountryResource&gt;|list&lt;GetCollectionCountryResource&gt;
     */</span>
    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">provide</span><span class="p">(</span><span class="kt">Operation</span> <span class="nv">$operation</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$uriVariables</span> <span class="o">=</span> <span class="p">[],</span> <span class="kt">array</span> <span class="nv">$context</span> <span class="o">=</span> <span class="p">[]):</span> <span class="kt">array</span><span class="o">|</span><span class="nc">Paginator</span>
    <span class="p">{</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$context</span><span class="p">[</span><span class="s1">'filters'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">??</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pagination</span><span class="o">-&gt;</span><span class="nf">isEnabled</span><span class="p">(</span><span class="nv">$operation</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pagination</span><span class="o">-&gt;</span><span class="nf">getPage</span><span class="p">(</span><span class="nv">$context</span><span class="p">);</span>
            <span class="nv">$limit</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">pagination</span><span class="o">-&gt;</span><span class="nf">getLimit</span><span class="p">(</span><span class="nv">$operation</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$models</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">queryBus</span><span class="o">-&gt;</span><span class="nf">ask</span><span class="p">(</span><span class="k">new</span> <span class="nc">GetCountriesQuery</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$limit</span><span class="p">));</span>

        <span class="nv">$resources</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$models</span> <span class="k">as</span> <span class="nv">$model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$resources</span><span class="p">[]</span> <span class="o">=</span> <span class="nc">GetCollectionCountryResource</span><span class="o">::</span><span class="nf">fromModel</span><span class="p">(</span><span class="nv">$model</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="nv">$paginator</span> <span class="o">=</span> <span class="nv">$models</span><span class="o">-&gt;</span><span class="nf">paginator</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$resources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Paginator</span><span class="p">(</span>
                <span class="k">new</span> <span class="nc">\ArrayIterator</span><span class="p">(</span><span class="nv">$resources</span><span class="p">),</span>
                <span class="p">(</span><span class="n">float</span><span class="p">)</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="nf">getCurrentPage</span><span class="p">(),</span>
                <span class="p">(</span><span class="n">float</span><span class="p">)</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="nf">getItemsPerPage</span><span class="p">(),</span>
                <span class="p">(</span><span class="n">float</span><span class="p">)</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="nf">getLastPage</span><span class="p">(),</span>
                <span class="p">(</span><span class="n">float</span><span class="p">)</span> <span class="nv">$paginator</span><span class="o">-&gt;</span><span class="nf">getTotalItems</span><span class="p">(),</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$resources</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This <strong><em>Provider</em></strong> contains a lot of <strong><em>API Platform</em></strong>-specific code, but I will take a moment to explain it, as it touches on some important <strong>DDD</strong> considerations.</p>

<p>First, I retrieve the name filter (if specified) and initialize pagination at 0. Then, I extract the pagination parameters from the URL (if pagination is enabled). Next, I dispatch the <strong>Query</strong>, responsible for fetching data from the system. After that, I iterate over the <strong>Entities</strong> returned by the <strong>Query</strong> and convert them into <strong><em>Resources</em></strong>. Finally, I apply pagination (if enabled) and return the <strong><em>Resources</em></strong>, whether paginated or not.</p>

<h3 id="future-considerations-3">Future Considerations</h3>
<p>Managing pagination should not be the responsibility of the <strong>QueryHandler</strong>—this is a concern of the <strong>Infrastructure</strong> or <strong>Application</strong> layer. We should adapt accordingly. To handle this correctly, we should implement a read model (via projections), but I realized this too late. For now, pagination is handled by the <strong>Repository</strong>, which is not a best practice. If you want a more detailed example, I have written an article on this topic <a href="https://huguesgobet.com/other/2024-12-16"><em>ici</em></a>.</p>

<p>Now that everything is clear, here is the <strong>Query</strong> we dispatch.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Application\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Application\Adapter\CountryRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Shared\Application\Query\QueryInterface</span><span class="p">;</span>

<span class="cd">/**
 * @implements QueryInterface&lt;CountryRepositoryInterface&gt;
 */</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">GetCountriesQuery</span> <span class="kd">implements</span> <span class="nc">QueryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="kt">?string</span> <span class="nv">$name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="k">public</span> <span class="kt">?int</span> <span class="nv">$page</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="k">public</span> <span class="kt">?int</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Within the <strong>QueryHandler</strong>:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Application\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Application\Adapter\CountryRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Shared\Application\Query\AsQueryHandler</span><span class="p">;</span>

<span class="na">#[AsQueryHandler]</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">GetCountriesQueryHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">CountryRepositoryInterface</span> <span class="nv">$countryRepository</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">GetCountriesQuery</span> <span class="nv">$query</span><span class="p">):</span> <span class="kt">CountryRepositoryInterface</span>
    <span class="p">{</span>
        <span class="nv">$countryRepository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">countryRepository</span><span class="p">;</span>

        <span class="nv">$countryRepository</span> <span class="o">=</span> <span class="nv">$countryRepository</span><span class="o">-&gt;</span><span class="nf">sortName</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$countryRepository</span> <span class="o">=</span> <span class="nv">$countryRepository</span><span class="o">-&gt;</span><span class="nf">withName</span><span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$countryRepository</span> <span class="o">=</span> <span class="nv">$countryRepository</span><span class="o">-&gt;</span><span class="nf">withPagination</span><span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$countryRepository</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I retrieve the <strong>Repository</strong> and specify that I want to sort results by name. If a <strong>name</strong> filter is provided, I instruct the <strong>Repository</strong> to only fetch matching <strong>Countries</strong>. If pagination is enabled, I tell the <strong>Repository</strong> to apply it (e.g., limiting results to thirty elements and fetching countries from page 2 onward).</p>

<p>What might seem unusual is that the <strong>Repository</strong> itself is returned—this is to align with <strong><em>API Platform</em></strong>’s structure and its pagination handling. Returning the <strong>Repository</strong> does not violate <strong>CQRS</strong> or <strong>DDD</strong> principles, which is why I accepted this approach.</p>

<h3 id="future-considerations-4">Future Considerations</h3>

<p>Using a read model would allow me to avoid this slightly unusual approach and remove pagination responsibility from the <strong>Repository</strong>, eliminating these oddities within the <strong>Domain</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Domain\Repository</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Country\Domain\Entity\Country</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Shared\Domain\Repository\RepositoryInterface</span><span class="p">;</span>

<span class="cd">/**
* @extends RepositoryInterface&lt;Country&gt;
*/</span>
<span class="kd">interface</span> <span class="nc">CountryRepositoryInterface</span> <span class="kd">extends</span> <span class="nc">RepositoryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ofName</span><span class="p">(</span><span class="kt">string</span> <span class="nc">Sname</span><span class="p">):</span> <span class="kt">?Country</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span> <span class="p">(</span><span class="kt">Country</span> <span class="nc">Scountry</span><span class="p">):</span> <span class="kt">void</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">withName</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">self</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">sortName</span><span class="p">():</span> <span class="kt">self</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This is what the <strong>Repository</strong> looks like. I will now show the <strong><em>Doctrine</em></strong> implementation. I won’t explain it, as it is not relevant to this article, but I believe it is important to show all the code for this section.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Country\Infrastructure\Doctrine\Repository</span><span class="p">;</span>

<span class="cd">/**
 * @extends DoctrineRepository&lt;Country&gt;
 */</span>
<span class="k">final</span> <span class="kd">class</span> <span class="nc">CountryDoctrineAdapter</span> <span class="kd">extends</span> <span class="nc">DoctrineRepository</span> <span class="kd">implements</span> <span class="nc">CountryAdapterInterface</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="no">string</span> <span class="no">ENTITY_CLASS</span> <span class="o">=</span> <span class="nc">Country</span><span class="o">::</span><span class="n">class</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="no">string</span> <span class="no">ALIAS</span> <span class="o">=</span> <span class="s1">'country'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">DocumentManager</span> <span class="nv">$documentManager</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">__construct</span><span class="p">(</span><span class="nv">$documentManager</span><span class="p">,</span> <span class="k">self</span><span class="o">::</span><span class="no">ENTITY_CLASS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ofName</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$name</span><span class="p">):</span> <span class="kt">?Country</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">documentManager</span><span class="o">-&gt;</span><span class="nf">getRepository</span><span class="p">(</span><span class="k">self</span><span class="o">::</span><span class="no">ENTITY_CLASS</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">findOneBy</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">Country</span> <span class="nv">$country</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">documentManager</span><span class="o">-&gt;</span><span class="nf">persist</span><span class="p">(</span><span class="nv">$country</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">documentManager</span><span class="o">-&gt;</span><span class="nb">flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">withName</span><span class="p">(</span>
        <span class="kt">string</span> <span class="nv">$name</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">filter</span><span class="p">(</span><span class="k">static</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Builder</span> <span class="nv">$qb</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$name</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
            <span class="nv">$qb</span><span class="o">-&gt;</span><span class="nf">field</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">text</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">sortName</span><span class="p">():</span> <span class="kt">self</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">filter</span><span class="p">(</span><span class="k">static</span> <span class="k">function</span> <span class="p">(</span><span class="kt">Builder</span> <span class="nv">$qb</span><span class="p">):</span> <span class="kt">void</span> <span class="p">{</span>
            <span class="nv">$qb</span><span class="o">-&gt;</span><span class="nb">sort</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'ASC'</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This was a very in-depth article! I covered <strong>TDD</strong> as well as the creation of a <strong>Supporting Domain</strong>. I also introduced two new <strong>Domain</strong> use cases. However, I haven’t yet had the opportunity to discuss the <strong>Core Domain</strong>. That will be the focus of a future article, where I will talk about communication between <strong>Domains</strong> and the many mistakes I made on this topic.</p>
</div><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2025-02-17T08:00:00+00:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
</footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/ddd-logbook/2025-01-27">Logbook of Learning Domain-Driven Design: Day 4</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hugues Gobet"><meta itemprop="url" content="https://huguesgobet.com"><meta itemprop="description" content="Développeur web, lead développeur et passionné d'architecture logicielle."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="https://huguesgobet.com"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:hugues.gobet@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Medium.">
        <a class="button button--circle medium-button" itemprop="sameAs" href="https://medium.com/https://medium.com/@hugues.gobet" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M834.7 279.8l61.3-58.9V208H683.7L532.4 586.4 360.3 208H137.7v12.9l71.6 86.6c7 6.4 10.6 15.8 9.7 25.2V673c2.2 12.3-1.7 24.8-10.3 33.7L128 805v12.7h228.6v-12.9l-80.6-98a39.99 39.99 0 0 1-11.1-33.7V378.7l200.7 439.2h23.3l172.6-439.2v349.9c0 9.2 0 11.1-6 17.2l-62.1 60.3V819h301.2v-12.9l-59.9-58.9c-5.2-4-7.9-10.7-6.8-17.2V297a18.1 18.1 0 0 1 6.8-17.2z"></path>
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/https://www.linkedin.com/in/hugues-gobet-854756bb/" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/https://github.com/tegbessou" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Blog - Hugues Gobet 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"></div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = true, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

