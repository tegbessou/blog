<!DOCTYPE html><html lang="fr">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-6H5WPV9WFH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-6H5WPV9WFH');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Journal de bord de l’apprentissage du Domain-Driven Design : Jour 4 - Blog - Hugues Gobet</title>

<meta name="description" content="Après trois articles axés sur la théorie - indispensables pour poser des bases solides - je vous propose aujourd’hui un cas concret : l’authentification d’un...">
<link rel="canonical" href="https://huguesgobet.com/fr/ddd-logbook/2025-01-27"><link rel="alternate" type="application/rss+xml" title="Blog - Hugues Gobet" href="/fr/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/fr/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/fr/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/fr/assets/favicon-16x16.png"><link rel="manifest" href="/fr/assets/site.webmanifest"><link rel="mask-icon" href="/fr/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/fr/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/fr/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/fr/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/fr/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="1280.000000pt" height="1026.000000pt" viewBox="0 0 1280.000000 1026.000000"
 preserveAspectRatio="xMidYMid meet">
<metadata>
Created by potrace 1.15, written by Peter Selinger 2001-2017
</metadata>
<g transform="translate(0.000000,1026.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M5230 10251 c-54 -17 -109 -53 -190 -126 -99 -88 -148 -115 -213
-115 -67 0 -118 24 -161 76 -45 53 -129 104 -174 104 -46 0 -113 -37 -217
-119 -50 -40 -119 -86 -155 -104 -58 -29 -74 -32 -150 -32 -66 0 -96 5 -134
23 -71 32 -174 31 -244 -4 -70 -35 -104 -90 -154 -250 l-41 -132 -38 -12 c-27
-9 -74 -11 -156 -7 -70 3 -135 2 -160 -5 -97 -24 -173 -134 -174 -255 0 -96
-13 -161 -35 -183 -13 -13 -56 -25 -139 -40 -173 -30 -203 -42 -280 -112 -111
-102 -124 -145 -101 -335 9 -71 13 -144 10 -161 -16 -77 -418 -346 -518 -345
-17 0 -64 12 -105 27 -179 67 -330 15 -440 -149 -44 -66 -111 -214 -111 -247
0 -7 -36 -28 -79 -46 -43 -18 -97 -48 -118 -67 -36 -30 -41 -40 -46 -90 -6
-64 -46 -158 -85 -199 -34 -36 -97 -65 -141 -66 l-34 0 7 93 c15 218 19 513 7
567 -27 128 -71 175 -161 174 -81 -1 -160 -42 -209 -107 -143 -196 -243 -451
-277 -712 -34 -251 4 -546 101 -805 21 -56 25 -85 28 -205 4 -198 22 -235 164
-341 75 -56 129 -119 140 -163 18 -78 93 -173 158 -202 22 -10 75 -22 118 -28
98 -14 130 -30 162 -84 20 -35 25 -57 25 -108 0 -117 29 -399 55 -523 57 -285
169 -527 365 -792 l68 -91 11 -136 c25 -294 110 -503 262 -641 131 -118 276
-168 489 -170 137 0 216 10 350 46 41 11 76 16 77 12 30 -88 150 -153 284
-154 l46 0 5 -98 c4 -66 14 -121 32 -174 24 -72 25 -79 11 -130 -31 -120 -109
-317 -186 -470 -17 -35 -93 -146 -169 -248 -170 -228 -234 -329 -370 -585
-172 -326 -193 -382 -194 -515 0 -58 4 -104 12 -117 16 -28 100 -59 215 -79
74 -13 136 -15 312 -11 271 7 478 37 663 98 73 24 69 16 75 184 3 66 10 132
16 147 5 15 57 90 114 165 249 331 395 568 486 794 l23 55 82 0 c58 0 99 7
146 23 48 17 78 22 113 17 62 -7 152 -56 223 -120 68 -62 79 -30 -96 -291
-162 -243 -216 -340 -340 -608 -131 -285 -152 -346 -158 -468 -6 -131 5 -161
66 -187 74 -32 153 -42 323 -42 162 0 304 15 489 51 113 23 315 81 360 104
l28 15 4 153 3 153 114 174 c210 320 307 493 392 695 l38 90 103 6 c189 10
241 56 322 282 22 59 65 103 117 119 35 10 53 8 132 -12 58 -14 133 -25 202
-27 100 -4 114 -2 155 19 56 29 84 76 105 178 24 112 43 156 80 189 48 42 100
47 200 21 208 -54 508 -75 965 -67 179 3 365 11 413 17 49 6 91 10 93 7 9 -9
-37 -193 -81 -325 -24 -73 -73 -194 -108 -270 -55 -119 -83 -164 -202 -323
-181 -240 -223 -307 -377 -594 -155 -292 -188 -376 -195 -500 -6 -110 3 -138
56 -165 195 -99 743 -81 1127 37 95 29 94 26 94 177 1 145 5 156 148 348 361
486 494 753 617 1237 23 93 25 116 25 345 0 135 4 247 8 250 15 9 120 -41 185
-87 171 -122 288 -340 343 -639 21 -112 29 -408 15 -533 -10 -93 -92 -401
-137 -517 -23 -56 -75 -142 -152 -248 -110 -152 -171 -292 -186 -430 -5 -42
-3 -46 29 -68 53 -34 174 -71 292 -88 132 -20 463 -22 643 -5 272 27 365 65
413 170 24 55 26 174 7 398 -16 181 -11 236 55 628 63 371 77 491 78 655 0
225 -11 275 -108 470 -173 346 -209 457 -208 645 0 216 38 368 184 738 259
657 333 954 355 1432 6 124 9 145 23 143 20 -4 43 -69 91 -253 92 -359 120
-668 120 -1339 l0 -418 -85 -133 c-250 -392 -320 -660 -236 -900 13 -37 32
-65 62 -92 101 -88 99 -86 99 -155 0 -49 -10 -94 -45 -196 -75 -220 -80 -329
-21 -457 20 -44 36 -60 97 -102 126 -84 160 -155 179 -373 19 -221 45 -287
152 -396 55 -56 74 -84 92 -135 13 -35 29 -65 35 -67 6 -2 43 28 81 67 89 90
151 215 216 436 75 256 98 375 120 637 5 59 13 80 81 200 157 275 189 367 180
506 -7 98 -34 198 -88 327 -38 93 -39 97 -39 222 -1 319 -31 371 -325 568
-164 111 -164 110 -210 281 -58 212 -66 309 -75 944 -9 612 -10 628 -65 985
-69 440 -188 714 -410 944 -138 143 -311 273 -530 399 -237 136 -561 475 -811
847 -216 321 -474 774 -474 833 0 17 16 86 36 154 20 68 44 153 52 190 15 66
15 66 -11 111 -36 62 -73 77 -186 77 -170 0 -246 35 -308 140 -69 118 -80 133
-126 167 -66 48 -131 71 -254 88 -119 17 -157 31 -196 70 -41 41 -63 82 -86
160 -26 84 -49 119 -107 163 -52 40 -118 62 -188 62 -28 0 -125 -18 -216 -40
-172 -42 -220 -47 -266 -30 -14 6 -68 50 -119 98 -125 118 -182 146 -295 146
-72 0 -101 -6 -193 -38 -103 -35 -111 -37 -163 -26 -30 7 -110 39 -177 73
-117 60 -125 62 -197 62 -92 0 -151 -27 -255 -116 -69 -60 -70 -60 -121 -55
-78 9 -108 23 -202 97 -132 105 -202 119 -367 73 -185 -53 -236 -45 -377 58
-79 58 -156 99 -181 97 -7 0 -23 -4 -37 -8z"/>
</g>
</svg>
<a title="Your Site Description
" href="/fr/">Blog - Hugues Gobet</a></div></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/fr/ddd-journey">Journal DDD</a></li><li class="navigation__item"><a href="/fr/other">Autres articles</a></li><li class="navigation__item"><a href="/fr/about">À propos</a></li></ul>
        <form id="language-switcher" action="" method="get">
          <select name="lang" onchange="location = this.value;">
            <option value="/fr/ddd-logbook/2025-01-27" selected>Français</option>
            <option value="/ddd-logbook/2025-01-27" >English</option>
          </select>
        </form>
        
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root">
    <div class="sidebar-profile">
        <img src="/assets/images/me.png" alt="Hugues Gobet" class="sidebar-avatar">
        <h2 class="sidebar-name">Hugues Gobet</h2>

        <p class="sidebar-bio">
            
                Développeur web, lead développeur et passionné d'architecture logicielle.
            
    </div>
    <div class="sidebar-social">
        <ul class="social-icons">
            
            <li>
                <a href="https://medium.com/@hugues.gobet" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-medium"></i>
                </a>
            </li>
            
            
            <li>
                <a href="https://www.linkedin.com/in/hugues-gobet-854756bb/" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-linkedin"></i>
                </a>
            </li>
            
            
            <li>
                <a href="https://github.com/tegbessou" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-github"></i>
                </a>
            </li>
            
        </ul>
    </div>
</div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>Journal de bord de l’apprentissage du Domain-Driven Design : Jour 4</h1></header></div><meta itemprop="headline" content="Journal de bord de l’apprentissage du Domain-Driven Design : Jour 4"><div class="article__info clearfix"><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>27 Jan, 2025</span>
            </li></ul></div><meta itemprop="author" content="Hugues Gobet"/><meta itemprop="datePublished" content="2025-01-27T08:00:00+00:00"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p>Après trois articles axés sur la théorie - indispensables pour poser des bases solides - je vous propose aujourd’hui un cas concret : l’authentification d’un utilisateur. Cet article s’éloigne légèrement du <strong>Domain Driven Design (DDD)</strong> pour se concentrer sur la mise en place et l’utilisation de l’<strong>Architecture Hexagonale</strong> et le <strong>CQRS</strong>. Je mentionnerai tout de même l’<strong>Entity User</strong>, mais l’essentiel portera sur l’aspect pratique. Si vous avez besoin d’un rappel sur ces concepts, vous pouvez vous référer à l’article du jour 2 qui les détaille (mettre un lien vers le jour 2).</p>

<h2 id="firebase-pour-simplifier-lauthentification-utilisateur">Firebase : pour simplifier l’authentification utilisateur</h2>

<p><strong><em>Firebase</em></strong> est une plateforme développée par Google qui fournit un ensemble d’outils et de services destinés à faciliter le développement, la gestion et la scalabilité des applications web et mobiles. Dans notre cas, elle sert de provider d’identité, simplifiant l’implémentation d’un système d’authentification. Cela permet notamment d’intégrer des options comme l’identification via Google ou Apple, sans se soucier du stockage des identifiants ou des mots de passe.</p>

<h3 id="voici-le-processus-général">Voici le processus général :</h3>

<ol>
  <li><strong><em>Firebase</em></strong> se charge de l’authentification et renvoie un <strong><em>JWT</em></strong> (JSON Web Token).</li>
  <li>Ce <strong><em>JWT</em></strong>, un standard pour échanger des informations sécurisées entre un client et un serveur, contient des données comme le nom et l’email de l’utilisateur.</li>
  <li>À chaque requête, on utilise ce <strong><em>JWT</em></strong> pour vérifier l’identité de l’utilisateur sans solliciter Firebase à nouveau. Pour cela, on délègue la partie login à Firebase, qui se charge de l’authentification de l’utilisateur et retourne un <strong><em>JWT</em></strong>.</li>
</ol>

<p><img src="/assets/images/2025-01-27/use-case.png" alt="Use case to be authenticated" /></p>

<h3 id="vision-du-futur">Vision du Futur</h3>

<p>Commencer un projet <strong>DDD</strong> en se focalisant sur l’authentification est une erreur. Cela détourne l’attention du cœur du domaine métier. L’objectif du <strong>DDD</strong> et de l’<strong>Architecture Hexagonale</strong> est de prioriser le métier en mettant de côté les aspects techniques au départ.</p>

<p>Cependant, une fois <strong><em>Firebase</em></strong> intégré, il est impératif de valider les <strong><em>JWT</em></strong> pour extraire des informations comme le nom et l’email.<br />
Pour ce faire, on utilise l’authentification de <strong><em>Symfony</em></strong>, en créant un <strong><em>Authenticator</em></strong> Custom pour s’adapter à <strong><em>Firebase</em></strong>. Notons qu’il existe plusieurs <strong><em>Authenticators</em></strong> déjà fournis dans <strong><em>Symfony</em></strong>, mais qu’aucun ne correspond à notre besoin. Le code de cette authentication n’est pas tellement intéressant au regard de la thématique de cette série d’articles, je ne m’y attarderai donc pas.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="code"><pre><span class="k">try</span> <span class="p">{</span>
    <span class="nc">SuserAuthenticated</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">commandBus</span><span class="o">-&gt;</span><span class="nf">dispatch</span> <span class="p">(</span>
        <span class="k">new</span> <span class="nc">AuthenticateUserCommand</span><span class="p">(</span>
            <span class="nc">Stoken</span><span class="p">,</span>
            <span class="nc">SproviderId</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">InvalidTokenException</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span>
        <span class="s1">'Log in user: Invalid token'</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s1">'exception'</span> <span class="o">=&gt;</span> <span class="nv">$exception</span><span class="p">,</span>
            <span class="s1">'provider'</span> <span class="o">=&gt;</span> <span class="nv">$providerId</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">);</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nc">AuthenticationException</span><span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">ExpiredTokenException</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span>
        <span class="s1">'Log in user: Token expired'</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s1">'exception'</span> <span class="o">=&gt;</span> <span class="nv">$exception</span><span class="p">,</span>
            <span class="s1">'provider'</span> <span class="o">=&gt;</span> <span class="nv">$providerId</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">);</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nc">AuthenticationException</span><span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">InvalidPayloadException</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">error</span><span class="p">(</span>
        <span class="s1">'Log in user: Invalid payload'</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s1">'exception'</span> <span class="o">=&gt;</span> <span class="nv">$exception</span><span class="p">,</span>
            <span class="s1">'provider'</span> <span class="o">=&gt;</span> <span class="nv">$providerId</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">);</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nc">AuthenticationException</span><span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">());</span>
<span class="p">}</span>

<span class="nc">Suser</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">queryBus</span><span class="o">-&gt;</span><span class="nf">ask</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">GetUserQuery</span><span class="p">(</span>
        <span class="nc">SuserAuthenticated</span><span class="err">→</span><span class="nf">email</span><span class="p">(),</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="nc">Semail</span> <span class="o">=</span> <span class="nc">Suser</span><span class="err">→</span><span class="nf">email</span><span class="p">();</span>

<span class="k">return</span> <span class="k">new</span> <span class="nc">SelfValidatingPassport</span><span class="p">(</span>
    <span class="k">new</span> <span class="nc">UserBadge</span><span class="p">(</span>
        <span class="nv">$email</span><span class="p">,</span>
        <span class="k">fn</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nc">Sthis</span><span class="o">-&gt;</span><span class="nf">loadUser</span> <span class="p">(</span><span class="nc">Semail</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="le-commandbus-pour-orchestrer-les-commandes">Le CommandBus : pour orchestrer les commandes</h2>

<p>L’entrée dans le système repose sur un <strong>Primary Adapter</strong> qui dispatche une commande CQRS AuthenticiteUserCommand via le <strong>CommandBus</strong>. Une fois la commande exécutée pour authentifier l’utilisateur, une <strong>Query</strong> GetUserQuery permet de récupérer ses données. Notons que l’<strong><em>Authenticator</em></strong> fait partie de la couche <strong>Infrastructure</strong>.</p>

<p>Le <strong>CommandBus</strong> est un système centralisé :</p>
<ul>
  <li>Il reçoit une commande en paramètre</li>
  <li>Il identifie le <strong>CommandHandler</strong> approprié</li>
  <li>Il exécute sa méthode <strong><em>Handle</em></strong></li>
  <li>Il retourne l’identité du résultat</li>
</ul>

<p>Pour respecter l’<strong>inversion de dépendance</strong> et les couches de l’<strong>Architecture Hexagonale</strong>, on crée une interface <strong><em>CommandBusInterface</em></strong> dans la couche <strong>Application</strong>. L’implémentation du CommandBus en utilisant <strong><em>Messenger</em></strong> (un composant de Symfony pour avoir une gestion de Bus) se trouve dans la couche <strong>Infrastructure</strong>.</p>

<p><strong>Interface CommandBusInterface:</strong></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">TegCorp\SharedKernelBundle\Application\Command</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">CommandBusInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @template T
     *
     * @param CommandInterface&lt;T&gt; $command
     *
     * @return T
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">dispatch</span><span class="p">(</span><span class="kt">CommandInterface</span> <span class="nv">$command</span><span class="p">):</span> <span class="kt">mixed</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><strong>Implémentation du CommandBus utilisant Messenger:</strong></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="k">final</span> <span class="kd">class</span> <span class="nc">MessengerCommandBus</span> <span class="kd">implements</span> <span class="nc">CommandBusInterface</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">HandleTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">MessageBusInterface</span> <span class="nv">$commandBus</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">messageBus</span> <span class="o">=</span> <span class="nv">$commandBus</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @template T
     *
     * @param CommandInterface&lt;T&gt; $command
     *
     * @return T
     */</span>
    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">dispatch</span><span class="p">(</span><span class="kt">CommandInterface</span> <span class="nv">$command</span><span class="p">):</span> <span class="kt">mixed</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="cm">/* @var T */</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">HandlerFailedException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getWrappedExceptions</span><span class="p">()))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$exception</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="vision-du-futur-1">Vision du Futur</h3>

<p>Il faudrait gérer les transactions.</p>

<h2 id="command-et-commandhandler">Command et CommandHandler</h2>

<p>Une <strong>Command</strong> est un objet simple, immuable, possédant les propriétés nécessaires à la réalisation de la modification sur le système. Pour respecter le contrat d’interface défini dans le CommandBus, il faut d’abord créer une interface pour les <strong>Command</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">TegCorp\SharedKernelBundle\Application\Command</span><span class="p">;</span>

<span class="cd">/**
 * @template T
 */</span>
<span class="kd">interface</span> <span class="nc">CommandInterface</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Cette interface permet d’avoir un retour du <strong>CommandHandler</strong> en utilisant les Generics de <strong><em>PHPStan</em></strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Application\Command</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Security\Domain\Service\AuthenticateUserFromProviderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\ValueObject\UserAuthenticated</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Application\Command\CommandInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Infrastructure\Webmozart\Assert</span><span class="p">;</span>

<span class="cd">/**
 * @implements CommandInterface&lt;UserAuthenticated&gt;
 */</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">AuthenticateUserCommand</span> <span class="kd">implements</span> <span class="nc">CommandInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nv">$providerId</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$token</span><span class="p">,</span>
        <span class="kt">string</span> <span class="nv">$providerId</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nc">Assert</span><span class="o">::</span><span class="nf">inArray</span><span class="p">(</span>
            <span class="nv">$providerId</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_APPLE</span><span class="p">,</span>
                <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_GOOGLE</span><span class="p">,</span>
                <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_FIREBASE</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">providerId</span> <span class="o">=</span> <span class="nv">$providerId</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Cette <strong>Command</strong> prend en paramètre un JWT envoyé par Firebase et un identifiant de provider qui permet de savoir qui est le provider d’identité (Google, Facebook…). L’id de provider est validée en fonction des valeurs supportées par notre système (Google, Apple et Firebase). Il est important de valider la cohérence des données qui rentrent dans le Domain, cela évite les comportements inattendus.</p>

<p>Ensuite vient le <strong>CommandHandler</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Application\Command</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Security\Domain\Entity\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\Exception\InvalidTokenException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\Repository\UserRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\Service\AuthenticateUser</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\ValueObject\UserAuthenticated</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\ValueObject\UserEmail</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Application\Command\AsCommandHandler</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Domain\Service\DomainEventDispatcherInterface</span><span class="p">;</span>

<span class="na">#[AsCommandHandler]</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">AuthenticateUserCommandHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">AuthenticateUser</span> <span class="nv">$authenticateUser</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">DomainEventDispatcherInterface</span> <span class="nv">$dispatcher</span><span class="p">,</span>
        <span class="k">private</span> <span class="kt">UserRepositoryInterface</span> <span class="nv">$userRepository</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @throws InvalidTokenException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">AuthenticateUserCommand</span> <span class="nv">$authenticateUserCommand</span><span class="p">):</span> <span class="kt">UserAuthenticated</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$authenticateUserCommand</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">InvalidTokenException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">match</span> <span class="p">(</span><span class="nv">$providerId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_APPLE</span> <span class="o">=&gt;</span> <span class="nv">$userAuthenticated</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">authenticateUserFromProvider</span><span class="o">-&gt;</span><span class="nf">authenticateUserWithApple</span><span class="p">(</span><span class="nv">$token</span><span class="p">),</span>
            <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_GOOGLE</span> <span class="o">=&gt;</span> <span class="nv">$userAuthenticated</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">authenticateUserFromProvider</span><span class="o">-&gt;</span><span class="nf">authenticateUserWithGoogle</span><span class="p">(</span><span class="nv">$token</span><span class="p">),</span>
            <span class="nc">AuthenticateUserFromProviderInterface</span><span class="o">::</span><span class="no">IDENTITY_PROVIDER_FIREBASE</span> <span class="o">=&gt;</span> <span class="nv">$userAuthenticated</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">authenticateUserFromProvider</span><span class="o">-&gt;</span><span class="nf">authenticateUserWithFirebase</span><span class="p">(</span><span class="nv">$token</span><span class="p">),</span>
            <span class="k">default</span> <span class="o">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IdentityProviderDoesntExistException</span><span class="p">(</span><span class="s1">'Invalid provider id'</span><span class="p">),</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nv">$userAuthenticated</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>J’ai utilisé une fois encore l’inversion de dépendance en injectant une interface d’un service <code class="language-plaintext highlighter-rouge">AuthenticateUserInterface</code> - qui se trouve dans la couche <strong>Application</strong> - dans le <strong>CommandHandler</strong> - qui se trouve aussi dans la couche <strong>Application</strong>. L’implémentation se trouve, quant à elle, dans la couche <strong>Infrastructure</strong> car elle dépend du service externe.</p>

<h3 id="vision-du-futur-2">Vision du Futur</h3>

<ul>
  <li>Il faudrait valider le JWT dans la Command comme dans le provider pour ne pas avoir cette gestion d’erreur.</li>
  <li>Il faudrait aussi réfléchir à l’utilisation du pattern <em>Stratégie</em> pour éviter le match.</li>
</ul>

<p>Dans ce <strong>CommandeHandler</strong>, on authentifie l’utilisateur en utilisant la méthode qui correspond au provider identifié, puis on retourne l’utilisateur authentifié.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Domain\ValueObject</span><span class="p">;</span>

<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">UserAuthenticated</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">UserEmail</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">string</span> <span class="nv">$email</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span> <span class="o">=</span> <span class="nc">UserEmail</span><span class="o">::</span><span class="nf">fromString</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">email</span><span class="p">():</span> <span class="kt">UserEmail</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="querybus-et-queryhandler">QueryBus et QueryHandler</h2>

<p>Une fois l’utilisateur authentifié, le <strong>QueryBus</strong> entre en jeu pour récupérer ses données métier. Les <strong>Query</strong> servent à lire des informations sans modifier le système. Ici aussi, une interface <strong><em>QueryBusInterface</em></strong> est définie en <strong>Application</strong>, et son implémentation avec <strong><em>Messenger</em></strong> se situe en <strong>Infrastructure</strong>.</p>

<p>Pour utiliser l’inversion de dépendance et respecter les couches de l’<strong>Architecture Hexagonale</strong>, j’ai créé une interface <strong><em>QueryBusInterface</em></strong> dans la couche Application. L’implémentation du QueryBus en utilisant <strong><em>Messenger</em></strong> se trouve dans la couche <strong>Infrastructure</strong>.</p>

<p><strong>Interface QueryBusInterface</strong></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">TegCorp\SharedKernelBundle\Application\Query</span><span class="p">;</span>

<span class="kd">interface</span> <span class="nc">QueryBusInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @template T
     *
     * @param QueryInterface&lt;T&gt; $query
     *
     * @return T
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ask</span><span class="p">(</span><span class="kt">QueryInterface</span> <span class="nv">$query</span><span class="p">):</span> <span class="kt">mixed</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><strong>Implémentation du MessengerQueryBus</strong></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="k">final</span> <span class="kd">class</span> <span class="nc">MessengerQueryBus</span> <span class="kd">implements</span> <span class="nc">QueryBusInterface</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">HandleTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">MessageBusInterface</span> <span class="nv">$queryBus</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">messageBus</span> <span class="o">=</span> <span class="nv">$queryBus</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @template T
     *
     * @param QueryInterface&lt;T&gt; $query
     *
     * @return T
     */</span>
    <span class="na">#[\Override]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">ask</span><span class="p">(</span><span class="kt">QueryInterface</span> <span class="nv">$query</span><span class="p">):</span> <span class="kt">mixed</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="cm">/* @var T */</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">handle</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">HandlerFailedException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span> <span class="o">=</span> <span class="nb">current</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getWrappedExceptions</span><span class="p">()))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nv">$exception</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="implémentation-de-la-query-et-du-queryhandler">Implémentation de la Query et du QueryHandler</h3>

<p>Après l’interface et l’implémentation du QueryBus, il faut implémenter la <strong>Query</strong> et le <strong>QueryHandler</strong>. Afin de respecter le contrat d’interface défini dans le QueryBu`, on crée une interface pour les <strong>Query</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">TegCorp\SharedKernelBundle\Application\Query</span><span class="p">;</span>

<span class="cd">/**
 * @template T
 */</span>
<span class="kd">interface</span> <span class="nc">QueryInterface</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Cette interface permet d’avoir un retour du <strong>QueryHandler</strong> en utilisant les Generics de <strong><em>PHPStan</em></strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Application\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Security\Application\ReadModel\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Application\Query\QueryInterface</span><span class="p">;</span>

<span class="cd">/**
 * @implements QueryInterface&lt;User&gt;
 */</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">GetUserQuery</span> <span class="kd">implements</span> <span class="nc">QueryInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="nv">$email</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Cette <strong>Query</strong> utilise l’identifiant du User et retourne une <strong>Entity User</strong>.</p>

<p>Ensuite vient le <strong>QueryHandler</strong> :</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Application\Query</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Security\Application\Adapter\UserAdapterInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Application\ReadModel\User</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\Exception\UserNotFoundException</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Application\Query\AsQueryHandler</span><span class="p">;</span>

<span class="na">#[AsQueryHandler]</span>
<span class="k">final</span> <span class="k">readonly</span> <span class="kd">class</span> <span class="nc">GetUserQueryHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="k">private</span> <span class="kt">UserAdapterInterface</span> <span class="nv">$userAdapter</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @throws UserNotFoundException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__invoke</span><span class="p">(</span><span class="kt">GetUserQuery</span> <span class="nv">$getUserQuery</span><span class="p">):</span> <span class="kt">User</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">userAdapter</span><span class="o">-&gt;</span><span class="nf">ofId</span><span class="p">(</span><span class="nv">$getUserQuery</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">UserNotFoundException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Une fois encore, j’ai utilisé l’inversion de dépendance en injectant dans le <strong>QueryHandler</strong> de la couche <strong>Application</strong> une interface d’un Repository <strong><em>UserRepositoryInterface</em></strong> de la couche <strong>Domain</strong>. L’implémentation se trouve toujours dans <strong>Infrastructure</strong> car elle dépend de la base de données que nous utilisons. L’inversion de dépendance laisse la possibilité de sauvegarder les informations où l’on veut et de changer de base de données.</p>

<h3 id="vision-du-futur-3">Vision du Futur</h3>

<p>Pour suivre le <strong>CQRS</strong>, il faudrait lire dans le <strong>Read Model</strong>. Je le mettrai en place plus tard.</p>

<p>Ce <strong>QueryHandler</strong> retourne une <strong>Entity User</strong>.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">declare</span><span class="p">(</span><span class="n">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="kn">namespace</span> <span class="nn">App\Security\Domain\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">App\Security\Domain\Event\UserCreated</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\ValueObject\UserEmail</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">App\Security\Domain\ValueObject\UserId</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="no">ORM</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Domain\Entity\EntityDomainEventTrait</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">TegCorp\SharedKernelBundle\Domain\Entity\EntityWithDomainEventInterface</span><span class="p">;</span>

<span class="na">#[ORM\Entity]</span>
<span class="k">final</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">EntityWithDomainEventInterface</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">EntityDomainEventTrait</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="na">#[ORM\Embedded(columnPrefix: false)]</span>
        <span class="k">private</span> <span class="kt">UserId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="na">#[ORM\Embedded(columnPrefix: false)]</span>
        <span class="k">private</span> <span class="kt">UserEmail</span> <span class="nv">$email</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">create</span><span class="p">(</span>
        <span class="kt">UserId</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="kt">UserEmail</span> <span class="nv">$email</span><span class="p">,</span>
    <span class="p">):</span> <span class="kt">self</span> <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">self</span><span class="p">(</span>
            <span class="nv">$id</span><span class="p">,</span>
            <span class="nv">$email</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="nv">$user</span><span class="o">::</span><span class="nf">recordEvent</span><span class="p">(</span>
            <span class="k">new</span> <span class="nc">UserCreated</span><span class="p">(</span>
                <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">id</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
                <span class="nv">$user</span><span class="o">-&gt;</span><span class="n">email</span><span class="o">-&gt;</span><span class="nf">value</span><span class="p">(),</span>
            <span class="p">),</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">id</span><span class="p">():</span> <span class="kt">UserId</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">email</span><span class="p">():</span> <span class="kt">UserEmail</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">email</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Dans cette Entity, on voit plusieurs choses dont on a parlé dans les articles précédents : les <strong>Value Object</strong>, les <strong>Event</strong>, les <strong>Factory</strong>…</p>

<h3 id="vision-du-futur-4">Vision du Futur</h3>

<p>Pour l’instant, il est possible de laisser les <strong><em>Attributs Doctrine</em></strong> dans l’<strong>Entity</strong>, mais je ne le recommande pas. Cela oblige en effet à faire des compromis entre le <strong>DDD</strong> et l’<strong><em>ORM</em></strong> et cela est déconseillé, surtout dans le <strong>Domain</strong>.</p>

<p>Après avoir fait cet <strong><em>Authenticator</em></strong>, à chaque requête, on passe dans cette classe pour authentifier le JWT envoyé. Il faut le faire à chaque fois car les requêtes à une <strong><em>API REST</em></strong> sont <em>stateless</em> (c’est à dire qu’on ne conserve pas d’état entre les requêtes).</p>

<p>Dans cet article j’ai détaillé l’implémentation d’une fonctionnalité du début à la fin, en partant de l’implémentation de la couche <strong>Infrastructure</strong> jusqu’au <strong>Domain</strong>. Je dirai pour conclure que cette fonctionnalité a été totalement pensée à l’envers. Dans le <strong>DDD</strong>, il faut commencer par la modélisation des <strong>Entity</strong> puis descendre jusqu’à l’implémentation des <strong>Interfaces</strong> définies dans le <strong>Domain</strong>. Cela peut également permettre de faire du <strong>TDD</strong> (Test-Driven Developpement) sur nos <strong>Entity</strong>.</p>

<p>J’évoquerai plus en détail la structure de cette <strong>Entity</strong> et de ces méthodes dans le prochain article qui parlera de la création d’un User.</p>
</div><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2025-01-27T08:00:00+00:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
</footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PRÉCÉDENT</span><a href="/fr/ddd-logbook/2025-01-13">Journal de bord de l’apprentissage du Domain-Driven Design : Jour 3</a></div><div class="next"><span>SUIVANT</span><a href="/fr/ddd-logbook/2025-02-17">Journal de bord de l’apprentissage du Domain-Driven Design : Jour 5</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hugues Gobet"><meta itemprop="url" content="https://huguesgobet.com"><meta itemprop="description" content="Développeur web, lead développeur et passionné d'architecture logicielle."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="https://huguesgobet.com"><li title="Envoyez-moi un courriel.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:hugues.gobet@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Suivez-moi sur Medium.">
        <a class="button button--circle medium-button" itemprop="sameAs" href="https://medium.com/https://medium.com/@hugues.gobet" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M834.7 279.8l61.3-58.9V208H683.7L532.4 586.4 360.3 208H137.7v12.9l71.6 86.6c7 6.4 10.6 15.8 9.7 25.2V673c2.2 12.3-1.7 24.8-10.3 33.7L128 805v12.7h228.6v-12.9l-80.6-98a39.99 39.99 0 0 1-11.1-33.7V378.7l200.7 439.2h23.3l172.6-439.2v349.9c0 9.2 0 11.1-6 17.2l-62.1 60.3V819h301.2v-12.9l-59.9-58.9c-5.2-4-7.9-10.7-6.8-17.2V297a18.1 18.1 0 0 1 6.8-17.2z"></path>
</svg>
</div>
        </a>
      </li><li title="Suivez-moi sur Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/https://www.linkedin.com/in/hugues-gobet-854756bb/" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Suivez-moi sur Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/https://github.com/tegbessou" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Blog - Hugues Gobet 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"></div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = true, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

